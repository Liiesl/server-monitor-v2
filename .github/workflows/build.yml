name: Build Windows Installer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Chocolatey
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    
    - name: Install NSIS
      shell: powershell
      run: |
        choco install nsis -y
        $nsisPath = "C:\Program Files (x86)\NSIS"
        if (Test-Path $nsisPath) {
          echo "$nsisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$nsisPath;$env:PATH"
        }
        # Verify NSIS installation
        & "C:\Program Files (x86)\NSIS\makensis.exe" /VERSION
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PySide6 psutil
    
    - name: Build with Nuitka (Standalone)
      uses: Nuitka/Nuitka-Action@main
      with:
        script-name: main.py
        mingw64: true
        mode: standalone
        windows-console-mode: disable
        enable-plugins: pyside6
        output-dir: dist
    
    - name: Create installer with NSIS
      shell: powershell
      run: |
        $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        if (Test-Path $nsisPath) {
          & $nsisPath ".github\script\installer.nsi"
        } else {
          Write-Error "NSIS not found at expected path"
          exit 1
        }
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist\NodeJS_Server_Manager_Setup.exe
        retention-days: 30

