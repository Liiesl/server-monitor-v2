name: Build Windows Installer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Chocolatey
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    
    - name: Install NSIS
      shell: powershell
      run: |
        choco install nsis -y
        $nsisPath = "C:\Program Files (x86)\NSIS"
        if (Test-Path $nsisPath) {
          echo "$nsisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$nsisPath;$env:PATH"
        }
        # Verify NSIS installation
        & "C:\Program Files (x86)\NSIS\makensis.exe" /VERSION
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PySide6 psutil
    
    - name: Build with Nuitka (Standalone)
      uses: Nuitka/Nuitka-Action@main
      with:
        script-name: main.py
        mingw64: true
        mode: standalone
        windows-console-mode: disable
        enable-plugins: pyside6
        output-dir: dist
    
    - name: Verify Nuitka build output
      shell: powershell
      run: |
        Write-Host "Checking dist directory structure..."
        if (Test-Path "dist") {
          Get-ChildItem -Path "dist" -Recurse | Select-Object FullName | ForEach-Object { Write-Host $_.FullName }
          
          # Check for expected paths
          $expectedPath1 = "dist\main.dist\main.exe"
          $expectedPath2 = "dist\main.exe"
          
          if (Test-Path $expectedPath1) {
            Write-Host "Found build output at: $expectedPath1"
          } elseif (Test-Path $expectedPath2) {
            Write-Host "Found build output at: $expectedPath2"
            Write-Warning "Build structure differs from expected. Updating installer script..."
          } else {
            Write-Error "Build output not found at expected locations!"
            Write-Error "Expected: $expectedPath1 or $expectedPath2"
            exit 1
          }
        } else {
          Write-Error "dist directory does not exist!"
          exit 1
        }
    
    - name: Create installer with NSIS
      shell: powershell
      working-directory: ${{ github.workspace }}
      run: |
        $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        if (Test-Path $nsisPath) {
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Building installer from: .github\script\installer.nsi"
          & $nsisPath ".github\script\installer.nsi"
        } else {
          Write-Error "NSIS not found at expected path"
          exit 1
        }
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist\NodeJS_Server_Manager_Setup.exe
        retention-days: 30

